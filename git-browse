#!/usr/bin/env python

import curses
import os

key_bindings = {}

def bind_keys(*keys):
    def decorator(func):
        for k in keys:
            code = ord(k) if type(k) is str else k
            key_bindings[code] = func.__name__
        return func
    return decorator


class GitBrowser(object):
    def __init__(self, stdscr, path, commit):
        self.stdscr = stdscr
        self.path = path
        self.commit = commit

        self.read_history()

        #TODO Create pads for commits and content

    def read_history(self):
        self.lines = []
        self.commits = {}

        p = os.popen('git blame -p %s %s' % (self.path, self.commit), 'r')

        while True:
            header = p.readline()
            if not header:
                break

            # Header format:
            # commit_sha original_line final_line[ lines_in_group]
            commit, original_line, final_line = header.split(' ')[:3]

            line = p.readline()

            # Parse any addition headers describing the commit
            commit_description = {}
            while not line.startswith('\t'):
                h_parts = line.split(' ', 1)
                h_field = h_parts[0]
                commit_description[h_field] = len(h_parts) < 2 or h_parts[1]

                line = p.readline()

            self.lines.append((commit, line[1:], ))

            if commit_description:
                self.commits[commit] = commit_description

    def draw(self):
        commits_pad = curses.newpad(len(self.lines)+1, 8)
        lines_pad = curses.newpad(len(self.lines)+1, 200) #FIXME width

        for i, (commit, line) in enumerate(self.lines):
            commits_pad.addstr(i, 0, commit[:7])
            lines_pad.addstr(i, 0, line)

        commits_pad.refresh(0,0, 0,0, self.height-1,8)
        lines_pad.refresh(0,0, 0,9, self.height-1,self.width-8)

    def wait_for_key(self):
        return
        return self.screen.getch()

    @property
    def width(self):
        return self.stdscr.getmaxyx()[1]

    @property
    def height(self):
        return self.stdscr.getmaxyx()[0]

    @bind_keys('j', curses.KEY_DOWN)
    def down(self, lines=1):
        self.stdscr.addstr(0, 0, "Down %d" % lines)

    @bind_keys('f')
    def page_down(self):
        self.down(self.height)

    @bind_keys('k', curses.KEY_UP)
    def up(self, lines=1):
        pass

    @bind_keys('b')
    def page_up(self):
        self.up(self.height)

    @bind_keys('g')
    def home(self):
        pass

    @bind_keys('G')
    def end(self):
        pass

    @bind_keys('n')
    def next_commit(self):
        #TODO Move to next commit
        self.read_history()

    @bind_keys('p')
    def prev_commit(self):
        #TODO Move to previous commit
        self.read_history()


def main_loop(stdscr, path, commit):
    browser = GitBrowser(stdscr, path, commit)

    while True:
        browser.draw()
        c = browser.wait_for_key()

        if c == ord('q'):
            return

        if c in key_bindings:
            getattr(browser, key_bindings[c])()

#TODO Get path and commit from command line
path = 'git-browse'
commit = 'HEAD'
curses.wrapper(main_loop, path, commit)
